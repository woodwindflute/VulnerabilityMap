// config map
let config = {
  minZoom: 7,
  maxZoom: 10,
};

// 創建地圖
const map = L.map("map", config).setView([23.5, 121], 7);

// 添加地圖底圖
L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution:
    '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
}).addTo(map);

const htmlTemplate =
  '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M32 18.451L16 6.031 0 18.451v-5.064L16 .967l16 12.42zM28 18v12h-8v-8h-8v8H4V18l12-9z" /></svg>';

// create custom button
const customControl = L.Control.extend({
  // button position
  options: {
    position: "topleft",
  },

  // method
  onAdd: function (map) {
    console.log(map.getCenter());
    // create button
    const btn = L.DomUtil.create("button");
    btn.title = "back to home";
    btn.innerHTML = htmlTemplate;
    btn.className += "leaflet-bar back-to-home hidden";

    return btn;
  },
});

// adding new button to map controll
map.addControl(new customControl());

// on drag end
map.on("moveend", getCenterOfMap);

const buttonBackToHome = document.querySelector(".back-to-home");

function getCenterOfMap() {
  buttonBackToHome.classList.remove("hidden");

  buttonBackToHome.addEventListener("click", () => {
    map.flyTo([lat, lng], zoom);
  });

  map.on("moveend", () => {
    const { lat: latCenter, lng: lngCenter } = map.getCenter();

    const latC = latCenter.toFixed(3) * 1;
    const lngC = lngCenter.toFixed(3) * 1;

    const defaultCoordinate = [+lat.toFixed(3), +lng.toFixed(3)];

    const centerCoordinate = [latC, lngC];

    if (compareToArrays(centerCoordinate, defaultCoordinate)) {
      buttonBackToHome.classList.add("hidden");
    }
  });
}

const compareToArrays = (a, b) => JSON.stringify(a) === JSON.stringify(b);

// Write Your Code!

// 加載行政區地理數據
var geojsonFeature;
var layerGroup;
var geojsonLayer;

fetch("taiwan.geojson")
  .then(response => response.json())
  .then(json => {
    geojsonFeature = json
    layerGroup = L.layerGroup().addTo(map);
    geojsonLayer = L.geoJSON(geojsonFeature, {
      style: defaultStyle
    }).addTo(layerGroup);
  });

// 定義樣式函數
function defaultStyle(feature) {
  return {
    fillColor: '#fffeee',
    weight: 1,
    opacity: 1,
    color: 'black',
    dashArray: '3',
    fillOpacity: 0.7
  };
}

// 定義樣式函數
function turnBlack(feature) {
  // 返回不同行政區的顏色樣式
  var color;
  var opacity;
  var weight;
  if (feature.properties.Cnty_name === '宜蘭縣') {
    color = 'black';
    opacity = 0.5;
  } else{
    color = '#fffeee';
    opacity = 0;
  }
  
  return {
    fillColor: color,
    weight: 0,
    dashArray: '3',
    fillOpacity: opacity
  };
}


// -------- 對外函示 ----------

function changeColor() {
  geojsonLayer = L.geoJSON(geojsonFeature, {
    style: turnBlack
  }).addTo(layerGroup);
}

function resetLayerStyle() {
  layerGroup.clearLayers();
  geojsonLayer = L.geoJSON(geojsonFeature, {
    style: defaultStyle
  }).addTo(layerGroup);
}

function colorGenerate(data) {
  // 色階的起點和終點顏色
  var startColor = "#5e4fa2";
  var endColor = "#9e0042";
  
  // 計算色階中段的顏色
  var middleColor = "#ffffbf";
  
  // 插值函數
  var colorScale = d3.interpolate(startColor, endColor);
  
  // 計算最小值和最大值
  var minValue = Math.min.apply(null, data);
  var maxValue = Math.max.apply(null, data);
  
  // 計算中間值
  var middleValue = minValue + (maxValue - minValue) / 2;
  
  // 將每個數字對應到色階的顏色
  var colorArray = data.map(function(value) {
    if (value === middleValue) {
      return middleColor;
    } else if (value < middleValue) {
      var t = (value - minValue) / (middleValue - minValue);
      return colorScale(t);
    } else {
      var t = (value - middleValue) / (maxValue - middleValue);
      return colorScale(t);
    }
  });
  return colorArray;
}
